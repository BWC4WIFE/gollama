name: Build and release

on:
  workflow_dispatch:

permissions:
  contents: write
  checks: write
  pull-requests: write
  packages: write
  statuses: write
  issues: write

jobs:
  build-multi-platform:
    name: Build for all platforms
    outputs:
      new_tag: ${{ steps.get_version.outputs.new_tag }}
    timeout-minutes: 25
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
            artifact_name: linux
          - os: windows-latest
            target: windows
            artifact_name: windows
          - os: macos-latest
            target: darwin
            artifact_name: darwin
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Get version
        id: get_version
        run: |
          # Get latest tag or use dev
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          # Increment patch version
          IFS='.' read -r major minor patch <<< "${TAG#v}"
          NEW_PATCH=$((patch + 1))
          NEW_TAG="v${major}.${minor}.${NEW_PATCH}"
          echo "new_tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${TAG}"
          echo "New tag: ${NEW_TAG}"

      - name: Build for ${{ matrix.target }}
        shell: bash
        env:
          GOLLAMA_VERSION: ${{ steps.get_version.outputs.new_tag }}
          GOOS: ${{ matrix.target }}
          GOARCH: amd64
          CGO_ENABLED: ${{ matrix.target == 'darwin' && '1' || '0' }}
        run: |
          set -x

          VERSION="${GOLLAMA_VERSION:-dev}"
          OUTPUT_NAME="gollama"

          # Set executable extension for Windows
          if [ "$GOOS" = "windows" ]; then
            OUTPUT_NAME="${OUTPUT_NAME}.exe"
          fi

          echo "Building for $GOOS/$GOARCH version $VERSION"

          # Build flags
          LDFLAGS="-s -w -X main.version=$VERSION"

          # Additional flags for Windows
          if [ "$GOOS" = "windows" ]; then
            LDFLAGS="$LDFLAGS -H=windowsgui"
          fi

          # Build the binary
          go build -trimpath -ldflags "$LDFLAGS" -o "$OUTPUT_NAME" ./cmd/gollama

          # Create archive
          if [ "$GOOS" = "windows" ]; then
            ARCHIVE_NAME="gollama-windows-amd64-${VERSION}.zip"
            zip -r "$ARCHIVE_NAME" "$OUTPUT_NAME" LICENSE README.md
          else
            ARCHIVE_NAME="gollama-${GOOS}-amd64-${VERSION}.tar.gz"
            tar czf "$ARCHIVE_NAME" "$OUTPUT_NAME" LICENSE README.md
          fi

          echo "‚úÖ Built: $ARCHIVE_NAME"
          ls -lh "$OUTPUT_NAME" "$ARCHIVE_NAME"

      - name: Upload ${{ matrix.target }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: gollama-${{ matrix.target }}
          path: |
            gollama-*-${{ steps.get_version.outputs.new_tag }}.*
            gollama${{ matrix.target == 'windows' && '.exe' || '' }}
          retention-days: 7

  build-windows-enhanced:
    name: Build Windows Enhanced
    needs: build-multi-platform
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: gollama-windows
          path: downloaded/

      - name: Create Windows installer package
        shell: powershell
        env:
          VERSION: ${{ needs.build-multi-platform.outputs.new_tag }}
        run: |
          $ErrorActionPreference = 'Stop'
          $Version = "$env:VERSION"

          # Extract the built executable
          $ZipFile = Get-ChildItem "downloaded\*.zip" | Select-Object -First 1
          if ($ZipFile) {
            Expand-Archive -Path $ZipFile.FullName -DestinationPath ".\extracted" -Force
          } else {
            # Build fresh if needed
            go build -trimpath -ldflags "-s -w -X main.version=$Version -H=windowsgui" -o gollama.exe ./cmd/gollama
            New-Item -ItemType Directory -Force -Path ".\extracted"
            Copy-Item gollama.exe ".\extracted\"
          }

          # Create enhanced Windows package
          $PackageDir = "gollama-windows-$Version"
          New-Item -ItemType Directory -Force -Path "dist\$PackageDir"

          # Copy files
          Copy-Item ".\extracted\gollama.exe" "dist\$PackageDir\"

          # Create Windows-specific README
          @"
          # gollama for Windows

          Version: $Version
          Build Date: $(Get-Date -Format "yyyy-MM-dd")

          ## Quick Start

          1. Extract this folder anywhere (no installation needed)
          2. Double-click `gollama.exe` or run from Command Prompt/PowerShell

          ## Command Line Usage

          ```powershell
          # Navigate to the gollama folder
          cd "path\to\$PackageDir"

          # Run the application
          .\gollama.exe

          # Get help
          .\gollama.exe --help

          # Estimate VRAM requirements
          .\gollama.exe estimate <model-name>
          ```
          
          ## Windows Features
          - Native GPU detection using Windows WMI
          - Optimized for Windows Terminal and PowerShell
          - Windows path handling
          - No dependencies required

          ## Requirements
          - Windows 10 or later (64-bit)
          - Ollama installed and running
          - 4GB+ RAM recommended

          ## Troubleshooting
          If you encounter issues:
          - Run as Administrator if having permission issues
          - Ensure Ollama is running: `ollama serve`
          - Check Windows Firewall isn't blocking connections

          ## Support
          GitHub: https://github.com/${{ github.repository }}
          "@ | Out-File -Encoding UTF8 "dist\$PackageDir\README-Windows.txt"

          # Copy license
          if (Test-Path LICENSE) {
            Copy-Item LICENSE "dist\$PackageDir\LICENSE.txt"
          }

          # Create ZIP
          Compress-Archive -Path "dist\$PackageDir\*" -DestinationPath "$PackageDir.zip" -CompressionLevel Optimal

          # Generate SHA256 hash
          $Hash = Get-FileHash "$PackageDir.zip" -Algorithm SHA256
          $Hash.Hash.ToLower() | Out-File -Encoding ASCII "dist\checksum.txt"

          echo "sha256=$($Hash.Hash.ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          echo "‚úÖ Windows package created: $PackageDir.zip"
          echo "SHA256: $($Hash.Hash.ToLower())"

      - name: Upload Windows enhanced package
        uses: actions/upload-artifact@v4
        with:
          name: gollama-windows-enhanced
          path: |
            gollama-windows-*.zip
            dist/checksum.txt
          retention-days: 30

  release:
    name: Create Release
    needs:
      - build-multi-platform
      - build-windows-enhanced
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: gollama-linux
          path: artifacts/

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: gollama-windows
          path: artifacts/

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: gollama-darwin
          path: artifacts/

      - name: Download Windows enhanced package
        uses: actions/download-artifact@v4
        with:
          name: gollama-windows-enhanced
          path: artifacts/

      - name: Prepare release assets
        shell: bash
        run: |
          # Move all release assets to a single directory
          mkdir -p release-assets
          find artifacts -name "*.zip" -o -name "*.tar.gz" | xargs -I {} cp {} release-assets/

          # List all assets
          echo "üì¶ Release assets:"
          ls -lh release-assets/

          # Generate checksums
          cd release-assets
          shasum -a 256 * > SHA256SUMS.txt
          echo "üîê Generated checksums:"
          cat SHA256SUMS.txt

      - name: Create GitHub release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build-multi-platform.outputs.new_tag }}
          release_name: Release ${{ needs.build-multi-platform.outputs.new_tag }}
          body: |
            # Release ${{ needs.build-multi-platform.outputs.new_tag }}

            ## Downloads

            ### Windows
            - **gollama-windows-${{ needs.build-multi-platform.outputs.new_tag }}.zip** - Portable Windows executable
            - Includes Windows-specific optimizations and WMI-based GPU detection

            ### Linux
            - **gollama-linux-amd64-${{ needs.build-multi-platform.outputs.new_tag }}.tar.gz** - Linux 64-bit binary

            ### macOS
            - **gollama-darwin-amd64-${{ needs.build-multi-platform.outputs.new_tag }}.tar.gz** - macOS 64-bit binary

            ## Windows-Specific Features

            This release includes Windows-optimized builds with:

            - **Native GPU Detection**: Uses Windows Management Instrumentation (WMI) for accurate VRAM detection
            - **Windows Console Optimization**: Better TUI experience in Windows Terminal, PowerShell, and CMD
            - **Windows Path Handling**: Proper handling of Windows file paths and environment variables

            ## Quick Start (Windows)

            ```powershell
            # Extract the ZIP file
            Expand-Archive gollama-windows-*.zip -DestinationPath gollama

            # Run the application
            cd gollama
            .\gollama.exe
            ```

            ## Verification

            Verify downloaded files using the SHA256 checksums in `SHA256SUMS.txt`.

            ## Support

            Report issues at: https://github.com/${{ github.repository }}/issues

            ---

            *Automated build from commit: ${{ github.sha }}*
          draft: false
          prerelease: false

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-assets/
          asset_name: release-assets-${{ needs.build-multi-platform.outputs.new_tag }}
          asset_content_type: application/zip

  cleanup:
    name: Cleanup cancelled workflow
    runs-on: ubuntu-latest
    if: cancelled()
    steps:
      - name: Cleanup cancelled workflow
        run: echo "Workflow was cancelled - this is normal if a new commit was pushed"
